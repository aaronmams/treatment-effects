---
title: "Average Treatment Effect Examples"
output: html_notebook
---

#Introduction
This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. These things are cool AF.

This workbook present a few simple ways to evaluate average treatment effects when some covariates are correlated with both the assignment to treatment and the outcome variable.  This is sometimes refered to as sample selection bias or the self selection problem.  Let's consider the example from Matai Cattaneo's 2010 *Journal of Econometrics* study of the effect of smoking during pregnancy on babys' birthweights.  The precise empirical problem posed here is that women choose whether or not to smoke, so assignment into treatment and control groups may be non-random.  Moreover, the probability of receiving the treatment (smoke v. not smoke) may be correlated with other variables in the model (like age) which are also correlated with the outcome.  This is sometimes refered to as a confounding variables problem.  

In order to conduct causal inference on the impact of smoking on birthweight we need to estimate the unconditional mean for each group (treatment and control).  What we observe is the outcome conditional on receiving the treatment or not.  In expirimental studies assignment into treatment-control groups is random and therefore uncorrelated with the outcome.  In this case, mean outcomes conditional on the treatment estimate the unconditional mean of interest.  In observational studies, if the assignment to treatment-control groups is non-random we need to model this assignment (called the treatment model).  If our treatment model is any good than the assignment to treatment conditional on covariates can be considered random and estimates of the unconditional group means can be obtained.

##Outline

This workbook illustrates a few approaches for estimating average treatment effects using observational data when self selection into the treatment grouping is a concern:

1. The potential outcome mean estimator (POM)
2. Comparison of weighted group means using inverse probability weights
3. Regression adjustment using propensity scores

##Global Options and Data

```{r}
#load some libraries
library(ggplot2)
library(dplyr)
```

The data we will use is from from Matai Cattaneo's 2010 *Journal of Econometrics* study.  These data contain, among other things, measurements on birthweight of 4642 newborn babies, maritial status of the mother, age of the mother, and smoking status (smoked v. did not smoke during pregnancy).

Let's get a quick look at the data:

```{r}
df <- tbl_df(read.csv('data/cattaneo2.csv'))
print.data.frame(df[1:5,])

```

##A Motivating Example: Basic Sample Selection Bias Illustration

The estimation of average treatment effects is often complicated by the issue of non-random assignment to treatment and control groups.  Here we illustrate this problem using some simulated data on baby's birthweight and mother's age and smoker/non-smoker status.  In this case, older mothers are more likely to smoke (read: more likely to receive the treatment) but older mothers also tend to give birth to heavier babies.

```{r}
#generate some data to illustrate the potential observed mean, probability of being a 
# smoker increases with age
age=rnorm(100,30,5)
#make the probability that a mother smokes increase with age
psmoke <-  pnorm((age-mean(age))/sd(age)) 
smoke <- rbinom(100,1,psmoke) 
#create a dataframe where birthweight is an increasing function of mother's age and smoking status 
z <- data.frame(age=age,smoke=smoke,bw=3000+(5*age)+(25*smoke) + rnorm(100,100,25))
#plot birthweight for smokers and non-smokers 
ggplot(z,aes(x=age,y=bw,color=factor(smoke))) + geom_point() + geom_smooth(method='lm') + ylab("birthweight") + 
  xlab("mother's age") + scale_color_discrete(name="Smoker") + theme_bw()

```

If we are interested in an unbiased estimate of the impact of smoking on birthweight the plot above suggests some issues...namely that we don't have very many smokers on the low end of the age distribution and, relatedly, we don't have many non-smokers in the high end of the age distribution.

#Potential Outcome Mean (POM) Estimator:

One way researchers have concocted to deal with this phenomenon is to use the Potential Outcome Mean (POM) estimator.  This basically amounts to running an OLS regression for each subsample of the data (smokers and non-smokers), using the coefficients of each regression to generate fitted values for the entire data sample, then comparing the means for each set of fitted values.  That was convoluted....an example will probably clarify things:

```{r}
lm.smoker <- lm(bweight~mage,data=df[df$mbsmoke=='smoker',])
pred.smoker <- predict(lm.smoker,newdata=df)
#mean(pred.smoker)

lm.ns <- lm(bweight~mage,data=df[df$mbsmoke!='smoker',])
pred.ns <- predict(lm.ns,newdata=df)
#mean(pred.ns)

#ATE using the POM approach is just the difference in mean fitted values for smokers and non-smokers
# using the two different regression models
ate <- mean(pred.smoker)-mean(pred.ns)
ate

```

It's important to note here that the pattern in the actual data (from Cattaneo 2010) is different from the one we simulated earlier (namely, in the actual data, younger mothers are more likely to smoke).

#Propensity Score Corrections

Another popular way of correcting for non-random assignment to treatment/control groups is to use propensity score weighting.  

The propensity score is basically the estimated probability that an individual with certain characteristics will receive the treatment.  We do this in two parts: first we estimate a model that predicts the probability that each invidual will be included in the treatment group conditional on some covariate values.  This is generally called the Treatment Model.  

In general, the Treatment Model can be specified many ways.  In this application we specify a probit model where the binary outcome, 'smoker' is modeled as function of age:

$P(Y=1|Age) = \Phi(\alpha + \beta age)$,

where $\Phi$ is the cumulative density function for the standard normal distribution.

##Inverse Probability Weighting Estimating...using the propensity score

The idea here is pretty simple: we are going to weight observations according to the inverse of thier probability of being included in the sample.  Outcomes from smokers will be weighted by $\frac{1}{p_i}$.  In the plot below we can see that this will attach a higher weight to outcomes from younger smokers.  Conversely, we will weight outcomes from non-smokers by $\frac{1}{1-p_i}$...this attaches a higher weight to older non-smokers.  In our simulated data sample is skewed by the fact that older mothers are more likely to smoke and more likey to have heavier babies.  The inverse probability weight correction deals with this by attaching higher weights to observations that are underrepresented in the sample (non-smoking older mothers and smoking younger mothers).  

```{r}
#start with the same fake data we used to illustrate the POM estimator
age=rnorm(100,30,5)
psmoke <-  pnorm((age-mean(age))/sd(age))
smoke <- rbinom(100,1,psmoke)
z <- data.frame(age=age,smoke=smoke,bw=3000+(5*age)+(25*smoke) + rnorm(100,100,25))

#calculate probability weights: fit a logit model and probit then use the fitted values as 
# probabilities
logit.bw <- glm(smoke~age,data=z,family='binomial')
probit.bw <- glm(smoke~age,data=z,family=binomial(link='probit'))
pi <- predict(probit.bw,newdata=z,type="response")

#weight smokers by 1/p(i) so that weight is large when probability of being a smoker is
# small.  Weight observations on non-smokers by 1/(1-p(i)) so weights are large when 
# probability is small
z <- tbl_df(z) %>% mutate(w=pi) %>% 
    mutate(weight=ifelse(smoke==1,1/w,1/(1-w)))

ggplot(z,aes(x=age,y=bw,color=factor(smoke),size=weight)) + geom_point(shape=1) + 
  scale_color_manual(values=c("red","black")) 

```


In the following chunk we estimate the Average Treatment Effect with our Cattaneo (2010) data using the inverse probability weights to adjust the means:

```{r}
#Treatment Model
#use the probit link for probability weights like they do in the STATA blog
probit.bw <- glm(mbsmoke~mage,data=df,family='binomial'(link='probit'))
pi <- predict(probit.bw,newdata=df,type="response")

#add inverse probability weights to the data frame
df <- tbl_df(df) %>% mutate(w=pi) %>% mutate(weight=ifelse(mbsmoke=='smoker',1/w,1/(1-w)),
                                             z=ifelse(mbsmoke=='smoker',1,0))

#Average Treatment Effect based on weighted average of groups: 
#Reference: http://onlinelibrary.wiley.com/doi/10.1002/sim.6607/epdf
weighted.mean.smoker <- (1/(sum(df$z/df$w)))*sum(df$z*df$bweight/df$w)
weighted.mean.ns <- (1/sum(((1-df$z)/(1-df$w))))*(sum(((1-df$z)*df$bweight)/(1-df$w)))

#ATE
weighted.mean.smoker - weighted.mean.ns

```

##Propensity Score Regression Adjustment

We can also use the propensity score as a regression adjustment.  A good reference for this estimator is http://www.stat.columbia.edu/~gelman/stuff_for_blog/posner.pdf.  

Using the propensity score as a regression adjustment simply amounts to including the propensity score ($p_i$) in a regression of birthweight on mother's age.

In the chunk below the treatment model is specified as a probit model where the [0,1] outcome smoker v. non-smoker is modeled as a function of age, age squared, marital status, education level, and an indicator for whether the mother has had a baby before.  Parameter estimates from this model are used to generate a predicted probability of smoking for each individual in the sample.  This predicted probability is the propensity score.  
```{r}

#the treatment model
pscore.df <- df %>% mutate(mage2=mage*mage) %>%
        mutate(marriedYN=ifelse(mmarried=='married',1,0),
               prenatal1YN=ifelse(prenatal1=='Yes',1,0))

ipwra.treat <- glm(factor(mbsmoke)~mage+marriedYN+fbaby+mage2+medu,data=pscore.df,family='binomial'(link='probit'))
pi <- predict(ipwra.treat,newdata=pscore.df,type="response")
df$ipwra.p <- pi
pscore.df <- df %>% mutate(ipwra.w=ifelse(mbsmoke=='smoker',1/ipwra.p,1/(1-ipwra.p)))

#Birthweight regression adjusted using the propensity score
summary(lm(bweight~factor(mbsmoke)+ipwra.p,data=pscore.df))

```

#Summary of Results

```{r}
data.frame(Estimator=c('Difference in POMs','Difference in IP Weighted Means','Regression Adjustment (Propensity Score)'),TreatmentEffect=c(-277.061,-275.50,-226.88))
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).